<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PH History Quiz</title>
  <style>
    body { font-family: system-ui, Arial; max-width:800px; margin:2rem auto; padding:1rem; }
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    button{padding:.5rem 1rem;margin:.25rem}
    .quiz-card{border:1px solid #ddd;padding:1rem;margin-bottom:1rem;border-radius:8px}
    .option{display:block;margin:0.4rem 0;padding:.5rem;border-radius:6px;border:1px solid #eee}
    .hidden{display:none}
    .score{font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1>History of the Philippines — Quiz</h1>
    <div>
      <span id="user-info">Not signed in</span>
      <button id="btn-signin">Sign in with Google</button>
      <button id="btn-signout" class="hidden">Sign out</button>
    </div>
  </header>

  <main>
    <section id="landing">
      <p>Take short quizzes on Philippine history to test your knowledge.</p>
      <div>
        <label for="quiz-select">Choose quiz:</label>
        <select id="quiz-select"></select>
        <button id="start-quiz">Start Quiz</button>
      </div>
    </section>

    <section id="quiz-area" class="hidden">
      <div id="question-container"></div>
      <div style="margin-top:.5rem">
        <button id="prev-btn">Previous</button>
        <button id="next-btn">Next</button>
        <button id="submit-btn">Submit</button>
      </div>
    </section>

    <section id="results-area" class="hidden">
      <h2>Results</h2>
      <p>Your score: <span id="score" class="score"></span></p>
      <button id="retake-btn">Retake</button>
      <h3>Your past attempts</h3>
      <ul id="attempts-list"></ul>
    </section>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

  <script>
  // === CONFIG -> Replace these with your Firebase project's config ===
  const firebaseConfig = {
    apiKey: "REPLACE_WITH_YOUR_API_KEY",
    authDomain: "REPLACE.firebaseapp.com",
    projectId: "REPLACE",
    // messagingSenderId, appId, etc (optional)
  };
  // ================================================================

  // Initialize
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // -------- Sample quiz data (you can move to Firestore later) ----------
  // Each quiz: id, title, questions: [{q, options:[...], answerIndex}]
  const localQuizzes = {
    "ph-history-1": {
      id: "ph-history-1",
      title: "Philippine Independence & Early Republic",
      questions: [
        {
          q: "When did the Philippines declare independence from Spain?",
          options: ["June 12, 1898", "December 10, 1898", "July 4, 1946", "June 12, 1901"],
          answerIndex: 0
        },
        {
          q: "Who led the Katipunan and was a national hero executed in 1896?",
          options: ["José Rizal", "Andrés Bonifacio", "Emilio Aguinaldo", "Apolinario Mabini"],
          answerIndex: 1
        },
        {
          q: "When was the Republic of the Philippines officially established after US colonial period?",
          options: ["1898", "1935", "1946", "1965"],
          answerIndex: 2
        }
      ]
    },
    "ph-history-2": {
      id: "ph-history-2",
      title: "Heroes & Revolutions",
      questions: [
        {
          q: "Which Philippine hero wrote 'Noli Me Tangere' and 'El Filibusterismo'?",
          options: ["Andrés Bonifacio", "José Rizal", "Melchora Aquino", "Juan Luna"],
          answerIndex: 1
        },
        {
          q: "Which revolution aimed to end Spanish rule in the Philippines?",
          options: ["People Power (EDSA) Revolution", "Philippine Revolution (1896)", "Revolution of 1986", "None of the above"],
          answerIndex: 1
        }
      ]
    }
  };

  // UI elements
  const btnSignIn = document.getElementById('btn-signin');
  const btnSignOut = document.getElementById('btn-signout');
  const userInfo = document.getElementById('user-info');
  const quizSelect = document.getElementById('quiz-select');
  const startQuizBtn = document.getElementById('start-quiz');
  const quizArea = document.getElementById('quiz-area');
  const landing = document.getElementById('landing');
  const questionContainer = document.getElementById('question-container');
  const nextBtn = document.getElementById('next-btn');
  const prevBtn = document.getElementById('prev-btn');
  const submitBtn = document.getElementById('submit-btn');
  const resultsArea = document.getElementById('results-area');
  const scoreEl = document.getElementById('score');
  const attemptsList = document.getElementById('attempts-list');
  const retakeBtn = document.getElementById('retake-btn');

  // Populate quiz select
  function populateQuizSelect(){
    quizSelect.innerHTML = '';
    for(const k in localQuizzes){
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = localQuizzes[k].title;
      quizSelect.appendChild(opt);
    }
  }
  populateQuizSelect();

  // Auth handlers
  btnSignIn.onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
    } catch(e){
      alert('Sign-in failed: ' + e.message);
    }
  };
  btnSignOut.onclick = () => auth.signOut();

  auth.onAuthStateChanged(user => {
    if(user){
      userInfo.textContent = user.displayName + " (" + user.email + ")";
      btnSignIn.classList.add('hidden');
      btnSignOut.classList.remove('hidden');
      loadUserAttempts(user.uid);
    } else {
      userInfo.textContent = "Not signed in";
      btnSignIn.classList.remove('hidden');
      btnSignOut.classList.add('hidden');
      attemptsList.innerHTML = '';
    }
  });

  // Quiz flow
  let currentQuiz = null;
  let currentIndex = 0;
  let answers = [];

  startQuizBtn.onclick = () => {
    currentQuiz = localQuizzes[quizSelect.value];
    if(!currentQuiz) { alert('Quiz not found'); return; }
    currentIndex = 0;
    answers = new Array(currentQuiz.questions.length).fill(null);
    landing.classList.add('hidden');
    resultsArea.classList.add('hidden');
    quizArea.classList.remove('hidden');
    renderQuestion();
  };

  function renderQuestion(){
    const item = currentQuiz.questions[currentIndex];
    questionContainer.innerHTML = `
      <div class="quiz-card">
        <h3>Q ${currentIndex+1} of ${currentQuiz.questions.length}</h3>
        <p>${item.q}</p>
        <div id="options"></div>
      </div>
    `;
    const optionsDiv = document.getElementById('options');
    item.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = 'option';
      btn.textContent = opt;
      if(answers[currentIndex] === i) btn.style.fontWeight = '700';
      btn.onclick = () => {
        answers[currentIndex] = i;
        // visually mark selected
        Array.from(optionsDiv.children).forEach(ch => ch.style.fontWeight='normal');
        btn.style.fontWeight = '700';
      };
      optionsDiv.appendChild(btn);
    });
  }

  nextBtn.onclick = () => {
    if(currentIndex < currentQuiz.questions.length - 1) {
      currentIndex++;
      renderQuestion();
    }
  };
  prevBtn.onclick = () => {
    if(currentIndex > 0) {
      currentIndex--;
      renderQuestion();
    }
  };

  submitBtn.onclick = async () => {
    // require sign in
    const user = auth.currentUser;
    if(!user){ if(!confirm('You are not signed in. Continue anonymously? (progress will not be saved)')) return; }

    // calculate score
    let correct = 0;
    currentQuiz.questions.forEach((q,i) => {
      if(answers[i] === q.answerIndex) correct++;
    });
    const percent = Math.round((correct / currentQuiz.questions.length) * 100);
    scoreEl.textContent = `${correct} / ${currentQuiz.questions.length} (${percent}%)`;

    // save attempt if signed in
    if(user){
      const attempt = {
        quizId: currentQuiz.id,
        quizTitle: currentQuiz.title,
        score: percent,
        correct,
        total: currentQuiz.questions.length,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        await db.collection('users').doc(user.uid).collection('attempts').add(attempt);
      } catch(e){
        console.error('Save failed', e);
      }
      // reload attempts list
      loadUserAttempts(user.uid);
    }

    quizArea.classList.add('hidden');
    resultsArea.classList.remove('hidden');
  };

  retakeBtn.onclick = () => {
    landing.classList.remove('hidden');
    resultsArea.classList.add('hidden');
  };

  // load user's past attempts
  async function loadUserAttempts(uid){
    attemptsList.innerHTML = '<li>Loading...</li>';
    try {
      const q = await db.collection('users').doc(uid).collection('attempts')
        .orderBy('timestamp', 'desc').limit(10).get();
      attemptsList.innerHTML = '';
      q.forEach(doc => {
        const data = doc.data();
        const ts = data.timestamp ? data.timestamp.toDate().toLocaleString() : '—';
        const li = document.createElement('li');
        li.textContent = `${data.quizTitle} — ${data.score}% (${data.correct}/${data.total}) on ${ts}`;
        attemptsList.appendChild(li);
      });
      if(q.empty) attemptsList.innerHTML = '<li>No attempts yet</li>';
    } catch(e){
      attemptsList.innerHTML = '<li>Could not load attempts</li>';
    }
  }

  // initial UI state
  landing.classList.remove('hidden');
  quizArea.classList.add('hidden');
  resultsArea.classList.add('hidden');
